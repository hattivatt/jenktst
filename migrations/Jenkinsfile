node ('master') {
   echo env.GIT_URL
   echo env.GIT_BRANCH
   git branch: 'main', url: 'https://github.com/hattivatt/jenktst'
   readProperties(interpolate: true, file: "migrations/${JOB_NAME.split('/')[0]}.properties").each {key, value -> env[key] = value }
   readProperties(interpolate: true, file: "migrations/.properties").each {key, value -> env[key] = value }
}

pipeline {

    agent none

    environment {
      FORUM_IMAGE_TAG="${env.ENV == "PROD" ? env.BRANCH_NAME : "latest"}"
    }
    stages {
        stage('test1') {
            agent { label "${env.ENV.toLowerCase()}" }
	    environment {
              NOTHING="${env.SOMETHING}"
              ANYTHING="ow"
	      OTTT="${env.ENV.toLowerCase()}"
	    }
            steps {
		script {
                  if (env.ENV == 'DEV')
		    sh '''#!/bin/bash
		          echo "I am conditional thingie"
		          echo "do not ever doubt it"'''
		}
		sh 'echo $FORUM_IMAGE_TAG'
		sh 'echo $NOTHING'
		sh 'echo $ANYTHING'
		sh 'printenv | sort'
            }
	    post {
              always {
	        sh 'echo "Hello, once again"'
		script {
                  if (env.ENV == 'DEV')
		    sh 'echo "This is still testing stuff"'
		}
	      }
	    }
        }
        stage('test2') {
            agent { label "${env.ENV.toLowerCase()}" }
	    when {
	        changeset "migrations/*.sh"
	    }
            steps {
                sh 'cd migrations; ./tests.sh'
            }
        }
        stage('test3') {
            agent { label "${env.ENV.toLowerCase()}" }
            steps {
                sh 'echo "Let\'s wrap it up"'
            }
        }
    }
    post {
      always {
        node('master') {
          deleteDir()
	}
      }
    }
}
